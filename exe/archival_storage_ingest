#!/usr/bin/env ruby
require 'optparse'
require 'archival_storage_ingest'

COMMAND_SERVER_START = 'start'.freeze
COMMAND_SERVER_STATUS = 'status'.freeze
COMMAND_SERVER_STOP = 'stop'.freeze

options = {}
OptionParser.new do |opts|
  opts.banner = 'Usage: archival_storage_ingest [options]'

  opts.on('-s COMMAND', '--server COMMAND', 'COMMAND, one of start, status, stop, defaults to status') do |s|
    if [COMMAND_SERVER_START, COMMAND_SERVER_STATUS, COMMAND_SERVER_STOP].include?(s)
      options[:server] = s
    else
      raise "Invalid server command #{s} given. Valid commands are " +
                COMMAND_SERVER_START + ', ' +
                COMMAND_SERVER_STATUS + ' and ' +
                COMMAND_SERVER_STOP
    end
  end

  opts.on('-i INGEST_CONFIG', '--ingest_config INGEST_CONFIG', 'Ingest config file') do |i|
    options[:ingest_config] = i
  end
end.parse!

if options[:server].nil? && options[:ingest_config].nil?
  raise 'One of -s or -i flag is required'
end

ingest_manager = ArchivalStorageIngest::IngestManager.new
if !options[:server].nil?
  ingest_manager.server
else
  puts 'Ingest called!'
  #  ingest_manager.queue_ingest(options[:ingest_config])
end
